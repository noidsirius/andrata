<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.20.1/dist/bootstrap-table.min.css">
    <style>

    </style>
  </head>
  <body>

    <div id="toolbar">
      <div class="row m-0">
        <!-- <button id="remove" class="btn btn-warning " disabled>
          <i class="fa fa-trash"></i> Exclude
        </button> -->
        <!-- <div class="vr m-1 ms-3"></div> -->
        <div class="col-md-3 col-sm-6 d-flex flex-row">
            <h6 class="m-2" style="width: 15em">#UI Tests</h6>
            <select class="numerical-filter form-select" id="num_androidTests_comparison">
              <option value=">="> &#62;= </option>
              <option value=">"> &#62; </option>
              <option value="="> = </option>
              <option value="<"> &#60; </option>
              <option value="<="> &#60;= </option>
            </select>
            <input id="num_androidTests_value" class="numerical-filter form-control" type="number" value="0">
        </div>
        <div class="col-md-3 col-sm-6 d-flex flex-row">
            <h6 class="m-2" style="width: 15em">#Unit Tests</h6>
            <select class="numerical-filter form-select" id="num_tests_comparison">
              <option value=">="> &#62;= </option>
              <option value=">"> &#62; </option>
              <option value="="> = </option>
              <option value="<"> &#60; </option>
              <option value="<="> &#60;= </option>
            </select>
            <input id="num_tests_value" class="numerical-filter form-control" type="number" value="0">
        </div>
        <div class="col-md-3 col-sm-6 d-flex flex-row">
            <h6 class="m-2">Star</h6>
            <select class="numerical-filter form-select" id="star_comparison">
              <option value=">="> &#62;= </option>
              <option value=">"> &#62; </option>
              <option value="="> = </option>
              <option value="<"> &#60; </option>
              <option value="<="> &#60;= </option>
            </select>
            <input id="star_value" class="numerical-filter form-control" type="number" value="0">
        </div>

        <div class="col-md-3 col-sm-6 d-flex flex-row">
            <h6 class="m-2">Fork</h6>
            <select class="numerical-filter form-select" id="fork_comparison">
              <option value=">="> &#62;= </option>
              <option value=">"> &#62; </option>
              <option value="="> = </option>
              <option value="<"> &#60; </option>
              <option value="<="> &#60;= </option>
            </select>
            <input id="fork_value" class="numerical-filter form-control" type="number" value="0">
        </div>
      </div>
      <div class="row pt-3">
        <div class="col-md-3 col-sm-6 d-flex flex-row">
            <h6 class="m-2">Installs</h6>
            <select class="numerical-filter form-select" id="install_comparison">
              <option value=">="> &#62;= </option>
              <option value=">"> &#62; </option>
              <option value="="> = </option>
              <option value="<"> &#60; </option>
              <option value="<="> &#60;= </option>
            </select>
            <input id="install_value" class="numerical-filter form-control" type="number" value="0">
        </div>

        <div class="col-md-3 col-sm-6 d-flex flex-row">
            <h6 class="m-2" style="width: 15em">#Pull Requests</h6>
            <select class="numerical-filter form-select" id="pr_comparison">
              <option value=">="> &#62;= </option>
              <option value=">"> &#62; </option>
              <option value="="> = </option>
              <option value="<"> &#60; </option>
              <option value="<="> &#60;= </option>
            </select>
            <input id="pr_value" class="numerical-filter form-control" type="number" value="0">
        </div>
        <div class="col-md-3 col-sm-6 d-flex flex-row">
            <h6 class="m-2" style="width: 15em">Created at</h6>
            <select class="numerical-filter form-select" id="create_date_comparison">
              <option value=">="> &#62;= </option>
              <option value=">"> &#62; </option>
              <option value="="> = </option>
              <option value="<"> &#60; </option>
              <option value="<="> &#60;= </option>
            </select>
            <input id="create_date_value" class="numerical-filter form-control" type="date" value="0">
        </div>

        <div class="col-md-3 col-sm-6 d-flex flex-row">
            <h6 class="m-2">Market</h6>
            <select class="numerical-filter form-select" id="market_value">
              <option value="play.google.com"> Google Play </option>
              <option value="ALL"> All </option>
              <option value="fdroid"> F-Droid </option>
              <option value="slideme"> SlideME </option>
              <option value="1mobile"> 1Mobile </option>
              <option value="PlayDrone"> PlayDrone </option>
            </select>
        </div>



      </div>
    </div>


    <!-- data-show-fullscreen="true" -->

      <!-- data-show-pagination-switch="true" -->
    <table
      id="table"
      data-toolbar="#toolbar"
      data-search="true"
      data-show-toggle="true"
      data-show-columns="true"
      data-show-fullscreen="true"
      data-show-columns-toggle-all="true"
      data-show-refresh="true"
      data-detail-view="true"
      data-show-export="true"
      data-click-to-select="true"
      data-detail-formatter="detailFormatter"
      data-minimum-count-columns="2"
      data-mobile-responsive="true"
      data-pagination="true"
      data-id-field="id"
      data-page-list="[10, 25, 50, 100, all]"
      data-url="flat2.json"
      data-response-handler="responseHandler">
      <!-- data-show-footer="true" -->
      <!-- data-side-pagination="server" -->
    </table>
    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/tableexport.jquery.plugin/tableExport.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.20.1/dist/bootstrap-table.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.20.1/dist/bootstrap-table-locale-all.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.20.1/dist/extensions/export/bootstrap-table-export.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.20.1/dist/extensions/mobile/bootstrap-table-mobile.min.js"></script>

    <script>
      var $table = $('#table')
      var $remove = $('#remove')
      var selections = []

      function getIdSelections() {
        return $.map($table.bootstrapTable('getSelections'), function (row) {
          return row.gh_name
        })
      }

      function responseHandler(res) {
        console.log(`Response: ${res.length}`)
        $.each(res.rows, function (i, row) {
          row.state = $.inArray(row.gh_name, selections) !== -1
        })
        return res
      }

      function detailFormatter(index, row) {
        var html = []
        $.each(row, function (key, value) {
          html.push('<p><b>' + key + ':</b> ' + value + '</p>')
        })
        return html.join('')
      }

      function operateFormatter(value, row, index) {
        return [
          '<a class="like" href="javascript:void(0)" title="Like">',
          '<i class="fa fa-heart"></i>',
          '</a>  ',
          '<a class="remove" href="javascript:void(0)" title="Remove">',
          '<i class="fa fa-trash"></i>',
          '</a>'
        ].join('')
      }

      window.operateEvents = {
        'click .like': function (e, value, row, index) {
          alert('You click like action, row: ' + JSON.stringify(row))
        },
        'click .remove': function (e, value, row, index) {
          $table.bootstrapTable('remove', {
            field: 'id',
            values: [row.id]
          })
        }
      }



      function initTable() {
        $table.bootstrapTable('destroy').bootstrapTable({
          height: 550,
          locale: 'en-US',
          columns: [
            [
            //   {
            //   field: 'state',
            //   checkbox: true,
            //   rowspan: 2,
            //   align: 'center',
            //   valign: 'middle'
            // },
            {
              title: 'Repo Name',
              field: 'gh_name',
              rowspan: 2,
              align: 'center',
              valign: 'middle',
              formatter: function(item){ return `<a href="https://github.com/${item}">${item}</a>`},
              sortable: true,
            }, {
              title: 'Code',
              colspan: 3,
              align: 'center'
            }, {
              title: 'Github',
              colspan: 6,
              align: 'center'
            },
            {
              title: 'Distribution',
              colspan: 6,
              align: 'center'
            }],
            [{
              field: 'num_androidTests',
              title: '#UI Tests',
              sortable: true,
              align: 'center',
            }, {
              field: 'num_tests',
              title: '#Unit Tests',
              sortable: true,
              align: 'center',
            }, {
              field: 'component',
              title: '#Components',
              sortable: true,
              align: 'center',
            }, {
              field: 'star',
              title: '#Stars',
              sortable: true,
              formatter: function(item, row){
                return item == "-1" ? "-" : item
              },
              align: 'center',
            }, {
              field: 'fork',
              title: '#Forks',
              sortable: true,
              formatter: function(item, row){
                return item == "-1" ? "-" : item
              },
              align: 'center',
            }, {
              field: 'pr',
              title: '#Pull Requests',
              sortable: true,
              formatter: function(item, row){
                return item == "-1" ? "-" : item
              },
              align: 'center',
            }, {
              field: 'commit',
              title: '#Commits',
              sortable: true,
              align: 'center',
            }, {
              field: 'contributor',
              title: '#Contributors',
              sortable: true,
              align: 'center',
            }, {
              field: 'create_date',
              title: 'Created at',
              sortable: true,
              formatter: function(item){
                return getDate(item)
              },
              sorter: function(a, b){
                new_date_a = getDate(a)
                new_date_b = getDate(b)
                if (new_date_a < new_date_b)
                  return -1
                else if (new_date_a > new_date_b)
                  return 1
                else
                  return 0
              },
              align: 'center',
            }, {
              field: 'category',
              title: 'Category',
              sortable: true,
              align: 'center'
            }, {
              field: 'package',
              title: 'PackageName',
              sortable: true,
              formatter: function(item, row){
                if (row['market'].includes('play.google.com'))
                  return `<a href="https://play.google.com/store/apps/details?id=${item}">${item}</a>`
                return item
              },
              align: 'center'
            }, {
              field: 'market',
              title: 'Market',
              sortable: true,
              align: 'center'
            }, {
              field: 'install',
              title: '#Installs',
              sortable: true,
              formatter: function(item, row){
                return item == "-1" ? "-" : item
              },
              align: 'center'
            }, {
              field: 'rating',
              title: 'Rating',
              sortable: true,
              formatter: function(item, row){
                return item == "-1" ? "-" : item
              },
              align: 'center'
            }, {
              field: 'rating_ppl',
              title: '#Rates',
              sortable: true,
              formatter: function(item, row){
                return item == "-1" ? "-" : item
              },
              align: 'center'
            }]
          ]
        })
        $table.on('check.bs.table uncheck.bs.table ' +
          'check-all.bs.table uncheck-all.bs.table',
        function () {
          $remove.prop('disabled', !$table.bootstrapTable('getSelections').length)

          // save your data, here just save the current page
          selections = getIdSelections()
          // push or splice the selections if you want to save all data selections
        })
        $table.on('all.bs.table', function (e, name, args) {
          console.log(name, args)
        })
        $remove.click(function () {
          var ids = getIdSelections();
          console.log(`Removing selected! '${ids}'`)
          $table.bootstrapTable('remove', {
            field: 'gh_name',
            values: ids
          })
          $remove.prop('disabled', true)
        })
        $('.numerical-filter').on('change',function () {
          updateTableByFilter();
        })
        updateTableByFilter();
      }

      function updateTableByFilter(){
        var filters = {
          'market': {'value': $(`#market_value`).val()}
        }
        for(let field of ['fork', 'star', 'num_androidTests', 'num_tests', 'install', 'pr', 'create_date']){
          filters[field] = {
            'comparison': $(`#${field}_comparison`).val(),
            'value': $(`#${field}_value`).val()
          }
        }
        filters['create_date']['value'] = `${filters['create_date']['value']} 00:00:00`
        $table.bootstrapTable('filterBy', filters, {'filterAlgorithm': customFilter});
      }


      function customFilter(row, filters){
        let match = true;
        for (const [field, attrs] of Object.entries(filters)){
          if (field == 'market')
          {
              if (attrs['value'] == 'ALL')
                continue;
              match = match && row['market'].includes(attrs['value'])
          }
          else
          {
            let value = row[field];
            if (field == 'create_date')
              value = getDate(value)
            if (attrs['comparison'] == ">")
              match = match && value > attrs['value']
            else if(attrs['comparison'] == ">=")
              match = match && value >= attrs['value']
            else if(attrs['comparison'] == "=")
              match = match && value == attrs['value']
            else if(attrs['comparison'] == "<=")
              match = match && value <= attrs['value']
            else
                match = match && value < attrs['value']
          }
        }
        return match;
      }

      function getDate(date_value){
        a_parts = date_value.trim().split(" ")
        a_d_parts = a_parts[1].split("/")
        new_date_a = `${a_d_parts[2]}-${a_d_parts[1]}-${a_d_parts[0]} ${a_parts[0]}`
        return new_date_a
      }

      $(function() {
        initTable()
        for(var field of ['category', 'component', 'commit', 'market', 'contributor'])
          $table.bootstrapTable('hideColumn', field)
      })
    </script>
  </body>
</html>
