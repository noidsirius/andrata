<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.20.1/dist/bootstrap-table.min.css">
    <style>

    </style>
  </head>
  <body>

    <div id="toolbar">
      <div class="d-flex flex-row">
        <!-- <button id="remove" class="btn btn-warning " disabled>
          <i class="fa fa-trash"></i> Exclude
        </button> -->
        <!-- <div class="vr m-1 ms-3"></div> -->
        <div class="d-flex flex-row p-1">
            <h6 class="mt-2 me-1">Star</h6>
            <select class="numerical-filter form-select p-1" id="star_comparison">
              <option value=">="> &#62;= </option>
              <option value=">"> &#62; </option>
              <option value="="> = </option>
              <option value="<"> &#60; </option>
              <option value="<="> &#60;= </option>
            </select>
            <input id="star_value" class="numerical-filter form-control p-1" type="number" value="0">
        </div>
        <div class="d-flex flex-row p-1">
            <h6 class="mt-2 me-1" style="width: 15em">#UI Tests</h6>
            <select class="numerical-filter form-select p-1" id="androidTests_comparison">
              <option value=">="> &#62;= </option>
              <option value=">"> &#62; </option>
              <option value="="> = </option>
              <option value="<"> &#60; </option>
              <option value="<="> &#60;= </option>
            </select>
            <input id="androidTests_value" class="numerical-filter form-control p-1" type="number" value="0">
        </div>
    </div>
      <!-- <div class="form-inline" role="form">

        <div class="form-group">
          <span>Offset: </span>
          <input name="offset" class="form-control w70" type="number" value="0">
        </div>
        <div class="form-group">
          <span>Limit: </span>
          <input name="limit" class="form-control w70" type="number" value="5">
        </div>
        <div class="form-group">
          <input name="search" class="form-control" type="text" placeholder="Search">
        </div>
        <button id="ok" type="submit" class="btn btn-primary">OK</button>
      </div> -->
    </div>

    <!-- data-show-fullscreen="true" -->

      <!-- data-show-pagination-switch="true" -->
    <table
      id="table"
      data-toolbar="#toolbar"
      data-search="true"
      data-show-toggle="true"
      data-show-columns="true"
      data-show-columns-toggle-all="true"
      data-show-refresh="true"
      data-detail-view="true"
      data-show-export="true"
      data-click-to-select="true"
      data-detail-formatter="detailFormatter"
      data-minimum-count-columns="2"
      data-query-params="queryParams"
      data-pagination="true"
      data-id-field="id"
      data-page-list="[10, 25, 50, 100, all]"
      data-url="flat2.json"
      data-response-handler="responseHandler">
      <!-- data-show-footer="true" -->
      <!-- data-side-pagination="server" -->
    </table>
    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/tableexport.jquery.plugin/tableExport.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.20.1/dist/bootstrap-table.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.20.1/dist/bootstrap-table-locale-all.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.20.1/dist/extensions/export/bootstrap-table-export.min.js"></script>
    <script>
      var $table = $('#table')
      var $remove = $('#remove')
      var selections = []

      function getIdSelections() {
        return $.map($table.bootstrapTable('getSelections'), function (row) {
          return row.gh_name
        })
      }

      function responseHandler(res) {
        console.log(`Response: ${res.length}`)
        $.each(res.rows, function (i, row) {
          row.state = $.inArray(row.gh_name, selections) !== -1
        })
        return res
      }

      function detailFormatter(index, row) {
        var html = []
        $.each(row, function (key, value) {
          html.push('<p><b>' + key + ':</b> ' + value + '</p>')
        })
        return html.join('')
      }

      function operateFormatter(value, row, index) {
        return [
          '<a class="like" href="javascript:void(0)" title="Like">',
          '<i class="fa fa-heart"></i>',
          '</a>  ',
          '<a class="remove" href="javascript:void(0)" title="Remove">',
          '<i class="fa fa-trash"></i>',
          '</a>'
        ].join('')
      }

      window.operateEvents = {
        'click .like': function (e, value, row, index) {
          alert('You click like action, row: ' + JSON.stringify(row))
        },
        'click .remove': function (e, value, row, index) {
          $table.bootstrapTable('remove', {
            field: 'id',
            values: [row.id]
          })
        }
      }

      function totalTextFormatter(data) {
        return 'Total'
      }

      function totalNameFormatter(data) {
        return data.length
      }

      function totalPriceFormatter(data) {
        var field = this.field
        return '$' + data.map(function (row) {
          return +row[field].substring(1)
        }).reduce(function (sum, i) {
          return sum + i
        }, 0)
      }

      function initTable() {
        $table.bootstrapTable('destroy').bootstrapTable({
          height: 550,
          locale: 'en-US',
          columns: [
            [
            //   {
            //   field: 'state',
            //   checkbox: true,
            //   rowspan: 2,
            //   align: 'center',
            //   valign: 'middle'
            // },
            {
              title: 'Repo Name',
              field: 'gh_name',
              rowspan: 2,
              align: 'center',
              valign: 'middle',
              sortable: true,
              footerFormatter: totalTextFormatter
            }, {
              title: 'Repo Detail',
              colspan: 4,
              align: 'center'
            }],
            [{
              field: 'category',
              title: 'Category',
              sortable: true,
              // footerFormatter: totalNameFormatter,
              align: 'center'
            }, {
              field: 'androidTests',
              title: '#UI Tests',
              sortable: true,
              align: 'center',
              // footerFormatter: totalPriceFormatter
            }, {
              field: 'star',
              title: '#Stars',
              sortable: true,
              align: 'center',
              // footerFormatter: totalPriceFormatter
            }, {
              field: 'commit',
              title: '#Commits',
              sortable: true,
              align: 'center',
              // footerFormatter: totalPriceFormatter
            }]
          ]
        })
        $table.on('check.bs.table uncheck.bs.table ' +
          'check-all.bs.table uncheck-all.bs.table',
        function () {
          $remove.prop('disabled', !$table.bootstrapTable('getSelections').length)

          // save your data, here just save the current page
          selections = getIdSelections()
          // push or splice the selections if you want to save all data selections
        })
        $table.on('all.bs.table', function (e, name, args) {
          console.log(name, args)
        })
        $remove.click(function () {
          var ids = getIdSelections();
          console.log(`Removing selected! '${ids}'`)
          $table.bootstrapTable('remove', {
            field: 'gh_name',
            values: ids
          })
          $remove.prop('disabled', true)
        })
        $('.numerical-filter').on('change',function () {
          var star_comparison = $('#star_comparison').val()
          var star_value = $('#star_value').val()
          var filters = {}
          for(let field of ['star', 'androidTests']){
            filters[field] = {
              'comparison': $(`#${field}_comparison`).val(),
              'value': $(`#${field}_value`).val()
            }
          }
          $('table').bootstrapTable('filterBy', filters, {'filterAlgorithm': customFilter});
        })
      }


      function customFilter(row, filters){
        let match = true;
        for (const [field, attrs] of Object.entries(filters)){
          if (attrs['comparison'] == ">")
            match = match && row[field] > attrs['value']
          else if(attrs['comparison'] == ">=")
            match = match && row[field] >= attrs['value']
          else if(attrs['comparison'] == "=")
            match = match && row[field] == attrs['value']
          else if(attrs['comparison'] == "<=")
            match = match && row[field] <= attrs['value']
          else
              match = match && row[field] < attrs['value']
        }
        return match;
      }


      $(function() {
        initTable()

        // $('#locale').change(initTable)
      })
    </script>
  </body>
</html>
